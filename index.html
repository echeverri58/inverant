<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Inversi√≥n del gobierno nacional en Antioquia</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        :root {
            --primary-color: #005A9C;
            --secondary-color: #FFD700; /* Amarillo/Dorado Antioquia */
            --background-color: #f4f7fc;
            --card-bg-color: #ffffff;
            --text-color: #333;
            --light-text-color: #777;
            --border-radius: 8px;
            --box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .container {
            width: 100%;
            max-width: 1400px;
        }
        header {
            text-align: center;
            margin-bottom: 20px;
        }
        header h1 {
            color: var(--primary-color);
            margin: 0;
        }
        header h1 .highlight {
            color: var(--secondary-color);
        }
        
        .filters {
            background-color: var(--card-bg-color);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-bottom: 30px;
            display: flex;
            gap: 20px;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
        }
        .filter-group { display: flex; flex-direction: column; }
        .filter-group label { font-weight: bold; margin-bottom: 5px; color: var(--primary-color); }
        .filter-group select { padding: 10px; border-radius: var(--border-radius); border: 1px solid #ccc; min-width: 200px; }
        .summary-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background-color: var(--card-bg-color); padding: 25px; border-radius: var(--border-radius); box-shadow: var(--box-shadow); text-align: center; transition: transform 0.2s; }
        .card:hover { transform: translateY(-5px); }
        .card h3 { margin: 0 0 10px 0; color: var(--primary-color); font-size: 1.1em; }
        .card .value { font-size: 2.2em; font-weight: bold; color: var(--text-color); }
        .charts { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .chart-container { background-color: var(--card-bg-color); padding: 20px; border-radius: var(--border-radius); box-shadow: var(--box-shadow); }
        .table-container { background-color: var(--card-bg-color); padding: 20px; border-radius: var(--border-radius); box-shadow: var(--box-shadow); overflow-x: auto; }
        #project-table { width: 100%; border-collapse: collapse; }
        #project-table th, #project-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #ddd; }
        #project-table th { background-color: var(--primary-color); color: white; }
        #project-table tbody tr:nth-child(even) { background-color: #f9f9f9; }
        #project-table tbody tr:hover { background-color: #f1f1f1; }
        .loader {
            border: 8px solid #f3f3f3;
            border-radius: 50%;
            border-top: 8px solid var(--primary-color);
            width: 60px;
            height: 60px;
            animation: spin 2s linear infinite;
            margin: 40px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <h1>üìä Dashboard de Inversi√≥n en <span class="highlight">Antioquia</span></h1>
            <p>An√°lisis interactivo de proyectos y recursos por Equipo UTL Senador Le√≥n Fredy Mu√±oz</p>
        </header>

        <div id="loader" class="loader"></div>
        
        <div id="dashboard-content" style="display: none;">
            <section class="filters">
                <div class="filter-group">
                    <label for="sector-filter">Filtrar por Sector</label>
                    <select id="sector-filter">
                        <option value="all">Todos los Sectores</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="status-filter">Filtrar por Estado</label>
                    <select id="status-filter">
                        <option value="all">Todos los Estados</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="bank-filter">Filtrar por Banco</label>
                    <select id="bank-filter">
                        <option value="all">Todos los Bancos</option>
                    </select>
                </div>
            </section>
            
            <section class="summary-cards">
                <div class="card">
                    <h3>üí∞ Valor Total de Inversi√≥n</h3>
                    <p class="value" id="total-investment">--</p>
                </div>
                <div class="card">
                    <h3>üèóÔ∏è Proyectos Totales</h3>
                    <p class="value" id="total-projects">--</p>
                </div>
                <div class="card">
                    <h3>‚úÖ Proyectos en Ejecuci√≥n</h3>
                    <p class="value" id="executing-projects">--</p>
                </div>
                <div class="card">
                    <h3>üìã Proyectos Formulados/Aprobados</h3>
                    <p class="value" id="formulation-projects">--</p>
                </div>
            </section>

            <section class="charts">
                <div class="chart-container">
                    <canvas id="investmentBySectorChart"></canvas>
                </div>
                <div class="chart-container">
                    <canvas id="projectsByStatusChart"></canvas>
                </div>
            </section>

            <section class="table-container">
                <h2>Detalle de Proyectos</h2>
                <table id="project-table">
                    <thead>
                        <tr>
                            <th>Sector</th>
                            <th>Entidad Responsable</th>
                            <th>Nombre Proyecto</th>
                            <th>Estado</th>
                            <th>Horizonte</th>
                            <th>Valor Total (COP)</th>
                            <th>Banco</th>
                        </tr>
                    </thead>
                    <tbody id="project-table-body"></tbody>
                </table>
            </section>
        </div>
    </div>

    <script>
        let originalData = [];
        let investmentBySectorChart, projectsByStatusChart;
        const csvFilePath = 'Inversion antioquia- tiempoCS.csv';

        document.addEventListener('DOMContentLoaded', () => {
            const loader = document.getElementById('loader');
            const dashboardContent = document.getElementById('dashboard-content');
            
            loader.style.display = 'block';
            dashboardContent.style.display = 'none';

            Papa.parse(csvFilePath, {
                download: true,
                header: true,
                delimiter: ";",
                skipEmptyLines: true,
                complete: function(results) {
                    originalData = results.data.map(d => ({
                        ...d,
                        'Valor Total': parseFloat(d['Valor Total']?.replace(/\./g, '').replace(',', '.') || 0)
                    }));
                    
                    if (originalData.length > 0) {
                        buildDashboard(originalData);
                        loader.style.display = 'none';
                        dashboardContent.style.display = 'block';
                    } else {
                        loader.style.display = 'none';
                        alert("El archivo CSV est√° vac√≠o o no se pudo procesar.");
                    }
                },
                error: function(error) {
                    loader.style.display = 'none';
                    alert("Error al leer el archivo CSV. Aseg√∫rate de que el archivo 'Inversion antioquia- tiempoCS.csv' existe en el mismo repositorio. Error: " + error.message);
                }
            });
        });

        function buildDashboard(data) {
            populateFilters(data);
            initializeDashboard(data);
            document.getElementById('sector-filter').addEventListener('change', updateDashboard);
            document.getElementById('status-filter').addEventListener('change', updateDashboard);
            document.getElementById('bank-filter').addEventListener('change', updateDashboard); // Evento para el nuevo filtro
        }
        
        function formatCurrency(value) {
            return new Intl.NumberFormat('es-CO', { 
                style: 'currency', currency: 'COP', minimumFractionDigits: 0, maximumFractionDigits: 0
            }).format(value);
        }

        function populateFilters(data) {
            const sectors = [...new Set(data.map(item => item.Sector).filter(Boolean))].sort();
            const statuses = [...new Set(data.map(item => item.Estado).filter(Boolean))].sort();
            const banks = [...new Set(data.map(item => item.Banco).filter(Boolean))].sort(); // Se obtienen los valores √∫nicos de 'Banco'
            
            const sectorFilter = document.getElementById('sector-filter');
            sectorFilter.innerHTML = '<option value="all">Todos los Sectores</option>';
            sectors.forEach(sector => {
                const option = document.createElement('option');
                option.value = sector;
                option.textContent = sector;
                sectorFilter.appendChild(option);
            });

            const statusFilter = document.getElementById('status-filter');
            statusFilter.innerHTML = '<option value="all">Todos los Estados</option>';
            statuses.forEach(status => {
                const option = document.createElement('option');
                option.value = status;
                option.textContent = status;
                statusFilter.appendChild(option);
            });

            const bankFilter = document.getElementById('bank-filter');
            bankFilter.innerHTML = '<option value="all">Todos los Bancos</option>';
            banks.forEach(bank => {
                const option = document.createElement('option');
                option.value = bank;
                option.textContent = bank;
                bankFilter.appendChild(option);
            });
        }

        function initializeDashboard(data) {
            updateSummaryCards(data);
            createOrUpdateCharts(data);
            updateTable(data);
        }
        
        function updateDashboard() {
            const selectedSector = document.getElementById('sector-filter').value;
            const selectedStatus = document.getElementById('status-filter').value;
            const selectedBank = document.getElementById('bank-filter').value; // Se obtiene el valor del nuevo filtro

            let filteredData = originalData;
            if (selectedSector !== 'all') {
                filteredData = filteredData.filter(d => d.Sector === selectedSector);
            }
            if (selectedStatus !== 'all') {
                filteredData = filteredData.filter(d => d.Estado === selectedStatus);
            }
            // L√≥gica para filtrar por banco
            if (selectedBank !== 'all') {
                filteredData = filteredData.filter(d => d.Banco === selectedBank);
            }

            updateSummaryCards(filteredData);
            createOrUpdateCharts(filteredData, true);
            updateTable(filteredData);
        }

        function updateSummaryCards(data) {
            const totalInvestment = data.reduce((sum, item) => sum + (item['Valor Total'] || 0), 0);
            const totalProjects = data.length;
            const executingProjects = data.filter(d => d.Estado === 'En Ejecuci√≥n').length;
            const formulationProjects = data.filter(d => d.Estado === 'Formulaci√≥n' || d.Estado === 'Aprobado').length;
            
            document.getElementById('total-investment').textContent = formatCurrency(totalInvestment);
            document.getElementById('total-projects').textContent = totalProjects.toLocaleString('es-CO');
            document.getElementById('executing-projects').textContent = executingProjects.toLocaleString('es-CO');
            document.getElementById('formulation-projects').textContent = formulationProjects.toLocaleString('es-CO');
        }

        function createOrUpdateCharts(data, isUpdate = false) {
            const investmentBySectorData = processDataForChart(data, 'Sector', 'Valor Total');
            if (isUpdate) {
                if(investmentBySectorChart) {
                    investmentBySectorChart.data.labels = investmentBySectorData.labels;
                    investmentBySectorChart.data.datasets[0].data = investmentBySectorData.values;
                    investmentBySectorChart.update();
                }
            } else {
                if(investmentBySectorChart) investmentBySectorChart.destroy();
                const investmentBySectorCtx = document.getElementById('investmentBySectorChart').getContext('2d');
                investmentBySectorChart = new Chart(investmentBySectorCtx, {
                    type: 'bar',
                    data: {
                        labels: investmentBySectorData.labels,
                        datasets: [{
                            label: 'Inversi√≥n por Sector', data: investmentBySectorData.values,
                            backgroundColor: '#005A9C', borderColor: '#004170', borderWidth: 1
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false,
                        plugins: { title: { display: true, text: 'Inversi√≥n Total por Sector', font: {size: 16}}, legend: { display: false },
                            tooltip: { callbacks: { label: context => formatCurrency(context.raw) } }
                        },
                        scales: { y: { beginAtZero: true, ticks: { callback: value => (value / 1e9).toFixed(1) + 'B' } } }
                    }
                });
            }

            const projectsByStatusData = processDataForChart(data, 'Estado');
            if (isUpdate) {
                if(projectsByStatusChart) {
                    projectsByStatusChart.data.labels = projectsByStatusData.labels;
                    projectsByStatusChart.data.datasets[0].data = projectsByStatusData.values;
                    projectsByStatusChart.update();
                }
            } else {
                if(projectsByStatusChart) projectsByStatusChart.destroy();
                const projectsByStatusCtx = document.getElementById('projectsByStatusChart').getContext('2d');
                projectsByStatusChart = new Chart(projectsByStatusCtx, {
                    type: 'doughnut',
                    data: {
                        labels: projectsByStatusData.labels,
                        datasets: [{ label: 'Proyectos por Estado', data: projectsByStatusData.values,
                            backgroundColor: ['#28a745', '#ffc107', '#007bff', '#dc3545', '#6c757d', '#17a2b8', '#343a40']
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false,
                        plugins: { title: { display: true, text: 'Distribuci√≥n de Proyectos por Estado', font: {size: 16}}, legend: { position: 'top' } }
                    }
                });
            }
        }
        
        function processDataForChart(data, groupKey, valueKey = null) {
            const grouped = data.reduce((acc, item) => {
                const key = item[groupKey];
                if (!key) return acc;
                if (!acc[key]) { acc[key] = { count: 0, sum: 0 }; }
                acc[key].count++;
                if (valueKey) { acc[key].sum += (item[valueKey] || 0); }
                return acc;
            }, {});
            const sortedLabels = Object.keys(grouped).sort((a, b) => valueKey ? grouped[b].sum - grouped[a].sum : grouped[b].count - grouped[a].count);
            const values = sortedLabels.map(label => valueKey ? grouped[label].sum : grouped[label].count);
            return { labels: sortedLabels, values: values };
        }
        
        function updateTable(data) {
            const tableBody = document.getElementById('project-table-body');
            tableBody.innerHTML = '';
            data.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.Sector || ''}</td>
                    <td>${item['Entidad Responsable'] || 'N/A'}</td>
                    <td>${item['Nombre Proyecto'] || ''}</td>
                    <td>${item.Estado || ''}</td>
                    <td>${item.Horizonte || ''}</td>
                    <td>${formatCurrency(item['Valor Total'] || 0)}</td>
                    <td>${item.Banco || ''}</td>
                `;
                tableBody.appendChild(row);
            });
        }
    </script>
</body>
</html>
